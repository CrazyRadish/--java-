<html>
<head>
  <title>数据约束与关联查询</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/10.0.14393 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2309"/>
<h1>数据约束与关联查询</h1>

<div>
<span><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>CREATE DATABASE day16;</div><div>USE day16;</div><div><br/></div><div>-- <b><span style="color: rgb(255, 0, 0);"><span style="font-size: 21px;">*************一、数据约束********************----</span></span></b></div><div>-- 1.1 默认值</div><div>CREATE TABLE student(</div><div>    id INT,</div><div>    NAME VARCHAR(20),</div><div>    address VARCHAR(20) DEFAULT 'tianhe guangzhou'  -- 默认值</div><div>)</div><div><br/></div><div>-- 当字段没有插入值的时候，mysql自动给该字段分配默认值</div><div>INSERT INTO student(id,NAME) VALUES(1,'zhangsan');</div><div><br/></div><div>-- 注意：默认值的字段允许为null</div><div>INSERT INTO student(id,NAME,address) VALUE(2,'lisi',NULL);</div><div>INSERT INTO student(id,NAME,address) VALUE(3,'wangwu','fanyu guangzhou');</div><div><br/></div><div>SELECT * FROM student;</div><div><br/></div><div>-- 1.2 非空</div><div>-- 需求： gender字段必须有值（不为null）</div><div>CREATE TABLE student(</div><div>    id INT,</div><div>    NAME VARCHAR(20),</div><div>    gender VARCHAR(2) NOT NULL -- 非空</div><div>)</div><div><br/></div><div>-- 非空字段必须赋值</div><div>INSERT INTO student(id,NAME) VALUES(1,'lisi');</div><div>-- 非空字符不能插入null</div><div>INSERT INTO student(id,NAME,gender) VALUES(1,'lisi',NULL);</div><div><br/></div><div>SELECT * FROM student;</div><div><br/></div><div>-- 1.3 唯一</div><div>CREATE TABLE student(</div><div>    id INT UNIQUE, -- 唯一</div><div>    NAME VARCHAR(20)</div><div>)</div><div><br/></div><div>INSERT INTO student(id,NAME) VALUES(1,'zhangsan');</div><div>INSERT INTO student(id,NAME) VALUES(1,'lisi'); -- ERROR 1062 (23000): Duplicate entry '1' for key 'id'</div><div><br/></div><div>INSERT INTO student(id,NAME) VALUES(2,'lisi');</div><div><br/></div><div>SELECT * FROM student;</div><div><br/></div><div>-- 1.4 主键（非空+唯一）</div><div>DROP TABLE student;</div><div><br/></div><div>CREATE TABLE student(</div><div>    id INT PRIMARY KEY, -- 主键</div><div>    NAME VARCHAR(20)</div><div>)</div><div><br/></div><div>INSERT INTO student(id,NAME) VALUES(1,'zhangsan');</div><div>INSERT INTO student(id,NAME) VALUES(2,'zhangsan');</div><div>-- INSERT INTO student(id,NAME) VALUES(1,'李四'); -- 违反唯一约束： Duplicate entry '1' for key 'PRIMARY'</div><div><br/></div><div>-- insert into student(name) value('李四'); -- 违反非空约束： ERROR 1048 (23000): Column 'id' cannot be null</div><div><br/></div><div>-- 1.5 自增长</div><div>CREATE TABLE student(</div><div>    id INT(4) ZEROFILL PRIMARY KEY AUTO_INCREMENT, -- 自增长，从0开始  ZEROFILL 零填充</div><div>    NAME VARCHAR(20)</div><div>)</div><div><br/></div><div>-- 自增长字段可以不赋值，自动递增</div><div>INSERT INTO student(NAME) VALUES('zhangsan');</div><div>INSERT INTO student(NAME) VALUES('lisi');</div><div>INSERT INTO student(NAME) VALUES('wangwu');</div><div><br/></div><div>SELECT * FROM student;</div><div>-- 不能影响自增长约束</div><div>DELETE FROM student;</div><div>-- 可以影响自增长约束</div><div>TRUNCATE TABLE student;</div><div><br/></div><div>-- 1.6 外键约束</div><div>-- 员工表</div><div>CREATE TABLE employee(</div><div>    id INT PRIMARY KEY,</div><div>    empName VARCHAR(20),</div><div>    deptName VARCHAR(20) -- 部门名称</div><div>)</div><div><br/></div><div>INSERT INTO employee VALUES(1,'zhangsan','softDept');</div><div>INSERT INTO employee VALUES(2,'lisi','appDept');</div><div>INSERT INTO employee VALUES(3,'wangwu','appDept');</div><div><br/></div><div>SELECT * FROM employee;</div><div><br/></div><div>-- 添加员工，部门名称的数据冗余高</div><div>INSERT INTO employee VALUES(4,'chenliu','软件开发部');</div><div><br/></div><div>-- 解决数据冗余高的问题：给冗余的字段放到一张独立表中</div><div>-- 独立设计一张部门表</div><div>CREATE TABLE dept(</div><div>    id INT PRIMARY KEY,</div><div>    deptName VARCHAR(20)</div><div>)</div><div><br/></div><div>DROP TABLE employee;</div><div><br/></div><div>-- 修改员工表</div><div>CREATE TABLE employee(</div><div>    id INT PRIMARY KEY,</div><div>    empName VARCHAR(20),</div><div>    deptId INT,-- 把部门名称改为部门ID</div><div>    -- 声明一个外键约束</div><div>    CONSTRAINT emlyee_dept_fk FOREIGN KEY(deptId) REFERENCES dept(id) ON UPDATE CASCADE ON DELETE CASCADE  -- ON CASCADE UPDATE ：级联修改</div><div>    --           外键名称                  外键               参考表(参考字段)</div><div>)</div><div><br/></div><div>INSERT INTO dept(id,deptName) VALUES(1,'softDept');</div><div>INSERT INTO dept(id,deptName) VALUES(2,'appDept');</div><div>INSERT INTO dept(id,deptName) VALUES(3,'secreteDept');</div><div><br/></div><div>INSERT INTO employee VALUES(1,'kaven',1);</div><div>INSERT INTO employee VALUES(2,'jelly',1);</div><div>INSERT INTO employee VALUES(3,'geoges',2);</div><div>INSERT INTO employee VALUES(4,'steven',3);</div><div><br/></div><div>-- 问题: 该记录业务上不合法，员工插入了一个不存在的部门数据</div><div>INSERT INTO employee VALUES(5,'陈六',4); -- 违反外键约束： Cannot add or update a child row: a foreign key constraint fails (`day16`.`employee`, CONSTRAINT `emlyee_dept_fk` FOREIGN KEY (`deptId`) REFERENCES `dept` (`id`))</div><div><br/></div><div>-- 1）当有了外键约束，添加数据的顺序： 先添加主表，再添加副表数据</div><div>-- 2）当有了外键约束，修改数据的顺序： 先修改副表，再修改主表数据</div><div>-- 3）当有了外键约束，删除数据的顺序： 先删除副表，再删除主表数据</div><div>-- 修改部门(不能直接修改主表)</div><div>UPDATE dept SET id=4 WHERE id=3;</div><div>-- 先修改员工表</div><div>UPDATE employee SET deptId=2 WHERE id=4;</div><div><br/></div><div>-- 删除部门</div><div>DELETE FROM dept WHERE id=2;</div><div><br/></div><div>-- 先删除员工表</div><div>DELETE FROM employee WHERE deptId=2;</div><div><br/></div><div>SELECT * FROM dept;</div><div>SELECT * FROM employee;</div><div><br/></div><div>-- 级联修改（修改）</div><div>-- 直接修改部门</div><div>UPDATE dept SET id=5 WHERE id=4;</div><div><br/></div><div>-- 级联删除</div><div>-- 直接删除部门</div><div>DELETE FROM dept WHERE id=1;</div><div><br/></div><div><br/></div><div><br/></div><div><b><span style="color: rgb(255, 0, 0);"><span style="font-size: 21px;">--  **************二、关联查询（多表查询）****************----</span></span></b></div><div>-- 需求：查询员工及其所在部门(显示员工姓名，部门名称)</div><div>-- 2.1 交叉连接查询（不推荐。产生笛卡尔乘积现象：4 * 4=16，有些是重复记录）</div><div>SELECT empName,deptName FROM employee,dept;</div><div><br/></div><div>-- 需求：查询员工及其所在部门(显示员工姓名，部门名称)</div><div>-- 多表查询规则：1）确定查询哪些表   2）确定哪些哪些字段   3）表与表之间连接条件 (规律：连接条件数量是表数量-1)</div><div>-- 2.2 内连接查询：只有满足条件的结果才会显示(使用最频繁)</div><div>SELECT empName,deptName       -- 2）确定哪些哪些字段</div><div>    FROM employee,dept    -- 1）确定查询哪些表</div><div>    WHERE employee.deptId=dept.id  -- 3）表与表之间连接条件</div><div><br/></div><div>-- 内连接的另一种语法</div><div>SELECT empName,deptName</div><div>    FROM employee</div><div>    INNER JOIN dept</div><div>    ON employee.deptId=dept.id;</div><div><br/></div><div>-- 使用别名</div><div>SELECT e.empName,d.deptName</div><div>    FROM employee e</div><div>    INNER JOIN dept d</div><div>    ON e.deptId=d.id;</div><div><br/></div><div>-- 需求： 查询每个部门的员工</div><div>-- 预期结果：</div><div> --  软件开发部  张三</div><div> --  软件开发部  李四</div><div> --  应用维护部  王五</div><div> --  秘书部      陈六</div><div> --  总经办      null</div><div>-- 2.2 左[外]连接查询： 使用左边表的数据去匹配右边表的数据，如果符合连接条件的结果则显示，如果不符合连接条件则显示null</div><div> -- （注意： 左外连接：左表的数据一定会完成显示！）</div><div>SELECT d.deptName,e.empName</div><div>    FROM dept d</div><div>    LEFT OUTER JOIN employee e</div><div>    ON d.id=e.deptId;</div><div><br/></div><div>-- 2.3 右[外]连接查询: 使用右边表的数据去匹配左边表的数据，如果符合连接条件的结果则显示，如果不符合连接条件则显示null</div><div> -- （注意： 右外连接：右表的数据一定会完成显示！）</div><div>SELECT d.deptName,e.empName</div><div>    FROM employee e</div><div>    RIGHT OUTER JOIN dept d</div><div>    ON d.id=e.deptId;</div><div><br/></div><div>-- 2.4 自连接查询</div><div>-- 需求：查询员工及其上司</div><div>-- 预期结果：       </div><div>    -- 张三    null</div><div>    -- 李四    张三</div><div>    -- 王五    李四</div><div>    -- 陈六    王五</div><div>SELECT e.empName,b.empName</div><div>    FROM employee e</div><div>    LEFT OUTER JOIN employee b</div><div>    ON e.bossId=b.id;</div><div><br/></div><div><br/></div><div>SELECT * FROM employee;</div><div>SELECT * FROM dept;</div><div>-- 添加上司ID</div><div>ALTER TABLE employee ADD bossId INT;</div><div>UPDATE employee SET bossId=1 WHERE id=2;</div><div>UPDATE employee SET bossId=2 WHERE id=3;</div><div>UPDATE employee SET bossId=3 WHERE id=4;</div></div><div><br/></div></span>
</div></body></html> 